<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="tr">
<head>
<meta charset="utf-8">
<meta name="description" content="rsync kullanamadığım için, değişen dosyaları bulmak için sha256, dosyaları upload etmek için ftputil kullanıyorum.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bloğu nasıl sunucuya yüklüyorum? | Python, Yazılım, ve Programlama</title>
<link href="../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/html4css1.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<link rel="canonical" href="http://ysar.net/python/sha256-ftputil.html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]--><meta name="author" content="Yaşar Arabacı">
<link rel="prev" href="../yazilim-dunyasi/neden-isletim-sistemi-gelistirmemeliyiz-ekleme.html" title="Neden İşletim Sistemi Geliştirmemeliyiz - Ekleme" type="text/html">
<link rel="next" href="debugging-decorator.html" title="Debugging Decorator" type="text/html">
<meta property="og:site_name" content="Python, Yazılım, ve Programlama">
<meta property="og:title" content="Bloğu nasıl sunucuya yüklüyorum?">
<meta property="og:url" content="http://ysar.net/python/sha256-ftputil.html">
<meta property="og:description" content="rsync kullanamadığım için, değişen dosyaları bulmak için sha256, dosyaları upload etmek için ftputil kullanıyorum.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2013-10-25T22:36:29+03:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Ana içeriğe geç</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://ysar.net/">

                <span id="blog-title">Python, Yazılım, ve Programlama</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" role="navigation" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../yasar-arabaci.html">Hakkımda</a>
                </li>
<li>
<a href="../rss.xml">RSS kaynağı</a>

                
            </li>
</ul>
<!-- Custom search with google--><form id="search" action="//www.google.com/search" method="get" class="navbar-form pull-left">
<input type="hidden" name="q" value="site:http://ysar.net/"><input type="text" name="q" maxlength="255" results="0" placeholder="Search">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Bloğu nasıl sunucuya yüklüyorum?</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    Yaşar Arabacı
            </span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2013-10-25T22:36:29+03:00" itemprop="datePublished" title="2013-10-25 22:36">2013-10-25 22:36</time></a></p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>Bu bloğu barındırdığım sunucumda, rsync kullanma ihtimalim yok, çünkü sadece
html dosyaları upload edebildiğim bir paket kullanıyorum. SSH erişimi gibi
bir şansım yok. Bundan önce dosyaları sunucuya atmak için, filezilla kullanıyordum.
Filezilla ile upload yaparken, boyutu farklı ise veya kaynak daha yeniyse upload
et gibi bir seçeneği var. Bu az çok işimi görüyordu. Ancak bunun da kendine göre
bir takım sıkıntıları var. Bazen output klasörünü silip baştan oluşturma ihtiyacı
duyuyorum. Bu gibi durumlarda, çoğu dosyanın içereği aslında değişmemiş olsa bile,
tüm dosyaları baştan upload ediyor. Bir de bazen dosyaları yanlış yere atma gibi
bir problem yaşıyorum. Geçenlerde anasayfa'nın index sayfası üzerine, başka
bir klasörün index sayfasını atmışım mesela, biraz geç farkettim. Ayrıca, önceden
attığım ama sonradan sildiğim içeriğin takibi yapmam da mümkün olmuyordu bu şekilde. <!-- TEASER_END --></p>
<p>Ben de şöyle birşey düşündüm, bütün dosyaların sha256 digest'lerini bir dosyada
tutuyorum. Yükleme yapacağım zaman, eski digest'leri yenileriyle karşılaştırıyorum.
Böylece, hangi dosyalar güncellenmiş, hangileri silinmiş, hangi dosyalar eklenmiş
görebiliyorum. Dosyaları yüklemek için de, başta Python'un ftplib modülünü denedim,
ama benim amaçlarım için fazla low-level bir modül olduğunu anladım. Daha sonra
<a href="https://pypi.python.org/pypi/ftputil/2.2.3">ftputil</a> modülünü buldum. Bu Python'un
kütüphanesine göre daha high-level bir kütüphane. İşimi bir hayli rahatlattı. Kodları
da göstereyim:</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="k">def</span> <span class="nf">create_hashes</span><span class="p">():</span>
    <span class="n">hashes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s2">"output"</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="c1"># there is no with statament in py 2.5 ...</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">hashes</span><span class="p">[</span><span class="n">filepath</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">hashes</span>

<span class="k">def</span> <span class="nf">write_hashes</span><span class="p">(</span><span class="n">hashes</span><span class="p">):</span>

    <span class="n">h</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"hashes"</span><span class="p">,</span><span class="s2">"w"</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">hexdigest</span> <span class="ow">in</span> <span class="n">hashes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">h</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="se">\0</span><span class="si">%s</span><span class="se">\n</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">hexdigest</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">h</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_hashes</span><span class="p">():</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"hashes"</span><span class="p">)</span>
    <span class="n">hashes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\0</span><span class="s1">'</span><span class="p">)</span>
            <span class="n">hashes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">hashes</span>
</pre>


<p>Bu <em>hash_utils.py</em> dosyası. 3 tane fonksiyonu var. <code>create_hashes</code> o anki durumun hash'lerini oluşturuyor. <code>write_hashes</code> kendisine verilen hash'leri dosyaya yazıyor. <code>get_hashes</code> ise dosyadaki hashleri okuyup döndürüyor.
Bu da <em>deploy.py</em> dosyam:</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">ftputil</span>
<span class="kn">import</span> <span class="nn">hash_utils</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">posixpath</span>

<span class="n">oldhashes</span> <span class="o">=</span> <span class="n">hash_utils</span><span class="o">.</span><span class="n">get_hashes</span><span class="p">()</span>
<span class="n">newhashes</span> <span class="o">=</span> <span class="n">hash_utils</span><span class="o">.</span><span class="n">create_hashes</span><span class="p">()</span>
<span class="c1"># print oldhashes</span>
<span class="c1"># print newhashes</span>

<span class="n">new_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="n">dangling_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="k">for</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">hexdigest</span> <span class="ow">in</span> <span class="n">oldhashes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">filepath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">newhashes</span><span class="p">:</span>
        <span class="n">dangling_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">newhashes</span><span class="p">[</span><span class="n">filepath</span><span class="p">]</span> <span class="o">!=</span> <span class="n">oldhashes</span><span class="p">[</span><span class="n">filepath</span><span class="p">]:</span>
        <span class="n">new_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<span class="k">for</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">newhashes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

    <span class="k">if</span> <span class="n">filepath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oldhashes</span><span class="p">:</span>
        <span class="n">new_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<span class="n">host</span> <span class="o">=</span> <span class="n">ftputil</span><span class="o">.</span><span class="n">FTPHost</span><span class="p">(</span><span class="s1">'ftphost'</span><span class="p">,</span> <span class="s1">'ftpname'</span><span class="p">,</span> <span class="s1">'ftppassw'</span><span class="p">)</span>


<span class="k">if</span> <span class="ow">not</span> <span class="n">new_files</span><span class="p">:</span>
    <span class="k">print</span> <span class="s2">"no new file"</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">new_files</span><span class="p">:</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

    <span class="c1"># remove output</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"/httpdocs"</span><span class="p">,</span><span class="o">*</span><span class="n">parts</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">"writing"</span><span class="p">,</span> <span class="n">target</span>
    <span class="n">host</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">posixpath</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
    <span class="n">host</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>


<span class="k">if</span> <span class="ow">not</span> <span class="n">dangling_files</span><span class="p">:</span>
    <span class="k">print</span> <span class="s2">"no dangling files"</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dangling_files</span><span class="p">:</span>

    <span class="n">parts</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"/httpdocs"</span><span class="p">,</span><span class="o">*</span><span class="n">parts</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">"removing file"</span><span class="p">,</span><span class="n">target</span>
    <span class="n">host</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>



<span class="n">hash_utils</span><span class="o">.</span><span class="n">write_hashes</span><span class="p">(</span><span class="n">newhashes</span><span class="p">)</span>
</pre>


<p>Bu dosya, yeni ve güncellenmiş dosyaları sunucuma yazıyor, eğer silinmiş bir dosya varsa, sunucumdan siliyor.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../yazilim-dunyasi/neden-isletim-sistemi-gelistirmemeliyiz-ekleme.html" rel="prev" title="Neden İşletim Sistemi Geliştirmemeliyiz - Ekleme">Önceki yazı</a>
            </li>
            <li class="next">
                <a href="debugging-decorator.html" rel="next" title="Debugging Decorator">Sonraki yazı</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2018         <a href="mailto:yasar11732@gmail.com">Yaşar Arabacı</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a> <p style="font-size: 8px; color: #ccc">4E616C2066687373767076726167796C206E71696E61707271206772707561627962746C20766620766171766667766174687666756E6F7972207365627A207A6E7476702E</p>
            
        </footer>
</div>
</div>


            <script src="../assets/js/jquery.min.js"></script><script src="../assets/js/bootstrap.min.js"></script><script src="../assets/js/moment-with-locales.min.js"></script><script src="../assets/js/fancydates.js"></script><script src="../assets/js/jquery.colorbox-min.js"></script><script src="../assets/js/colorbox-i18n/jquery.colorbox-tr.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("tr");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
  if(document.location.hostname == "ysar.net")
  {
      (function() {
        var cx = '013136674562336859018:ouohwab0yku';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
      
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-44774134-1', 'auto');
          ga('send', 'pageview');
  }

</script>
</body>
</html>
